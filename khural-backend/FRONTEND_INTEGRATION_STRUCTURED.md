# Структурированная документация по интеграции фронтенда

> Автоматически сгенерировано на основе `FRONTEND_INTEGRATION.md`

## Быстрый индекс

- [Быстрый старт](#быстрый-старт)
  - [Базовый URL](#1-базовый-url)
  - [Настройка HTTP клиента](#2-настройка-http-клиента)
    - [Пример с fetch API](#пример-с-fetch-api)
    - [Пример с axios](#пример-с-axios)
- [Аутентификация](#аутентификация)
  - [Вход в систему](#1-вход-в-систему)
  - [Обновление токена](#2-обновление-токена)
  - [Выход из системы](#3-выход-из-системы)
- [Работа с данными](#работа-с-данными)
  - [Получение списка новостей](#получение-списка-новостей)
  - [Создание новости](#создание-новости)
  - [Загрузка файла](#загрузка-файла)
  - [Поиск документов](#поиск-документов)
- [Обработка ошибок](#обработка-ошибок)
  - [Универсальный обработчик ошибок](#универсальный-обработчик-ошибок)
- [React Hook примеры](#react-hook-примеры)
  - [Хук для работы с новостями](#хук-для-работы-с-новостями)
  - [Хук для аутентификации](#хук-для-аутентификации)
- [Работа с файлами](#работа-с-файлами)
  - [Загрузка изображения](#загрузка-изображения)
  - [Получение ссылки на файл](#получение-ссылки-на-файл)
- [Пагинация](#пагинация)
  - [Компонент пагинации](#компонент-пагинации)
- [Рекомендации](#рекомендации)
- [Полезные ссылки](#полезные-ссылки)

---

## Быстрый старт

### 1. Базовый URL

**Описание:** Установка базового URL для API запросов.

**Пример:**
```typescript
const API_BASE_URL = 'http://localhost:4000'; // или ваш production URL
```

**Примечания:**
- Для разработки используйте `http://localhost:4000`
- Для production замените на актуальный URL сервера

---

### 2. Настройка HTTP клиента

**Описание:** Настройка HTTP клиента для работы с API. Поддерживаются два подхода: `fetch API` и `axios`.

#### Пример с fetch API

**Описание:** Реализация API клиента на основе нативного `fetch` API.

**Основные возможности:**
- Управление токенами доступа
- Обработка ошибок
- Поддержка всех HTTP методов (GET, POST, PATCH, DELETE)
- Загрузка файлов через FormData

**Ключевые методы:**
- `setAccessToken(token: string)` - установка токена доступа
- `get<T>(endpoint: string)` - GET запрос
- `post<T>(endpoint: string, data?: any)` - POST запрос
- `patch<T>(endpoint: string, data?: any)` - PATCH запрос
- `delete<T>(endpoint: string)` - DELETE запрос
- `uploadFile<T>(endpoint: string, file: File, fieldName?: string)` - загрузка файла

**Пример использования:**
```typescript
const api = new ApiClient('http://localhost:4000');
api.setAccessToken('your-token');
const news = await api.get<News[]>('/news');
```

**Примечания:**
- Токен автоматически добавляется в заголовок `Authorization: Bearer {token}`
- Все ответы оборачиваются в `ApiResponse<T>` формат
- Ошибки автоматически обрабатываются и выбрасываются как исключения

#### Пример с axios

**Описание:** Реализация API клиента на основе библиотеки `axios`.

**Основные возможности:**
- Автоматическое добавление токена к каждому запросу через interceptors
- Автоматическое обновление токена при 401 ошибке
- Редирект на страницу входа при истечении refresh токена
- Поддержка всех HTTP методов
- Загрузка файлов

**Ключевые особенности:**
- **Request Interceptor:** Автоматически добавляет токен из `localStorage` к каждому запросу
- **Response Interceptor:** Обрабатывает 401 ошибки, пытается обновить токен через `/auth/refresh`
- Автоматический редирект на `/login` при неудачном обновлении токена

**Пример использования:**
```typescript
const api = new ApiClient('http://localhost:4000');
const news = await api.get<News[]>('/news');
```

**Примечания:**
- Требует установки `axios`: `npm install axios`
- Токены хранятся в `localStorage` с ключами `access_token` и `refresh_token`
- При 401 ошибке автоматически пытается обновить токен

---

## Аутентификация

### 1. Вход в систему

**Описание:** Методы входа в систему: по email/паролю и по телефону.

#### Вход по email и паролю

**Endpoint:** `POST /auth/login/password`

**Параметры:**
- `email: string` - email пользователя
- `password: string` - пароль пользователя

**Возвращает:** `UserCredentials` объект с токенами доступа

**Пример:**
```typescript
const credentials = await login('user@example.com', 'password123');
// credentials содержит: access_token, refresh_token, user, и другие поля
```

**Примечания:**
- Токены автоматически сохраняются в `localStorage`
- Токен доступа устанавливается для последующих запросов

#### Вход по телефону

**Endpoint:** `POST /auth/login`

**Параметры:**
- `phone: string` - номер телефона пользователя

**Возвращает:** `UserCredentials` объект с токенами доступа

**Пример:**
```typescript
const credentials = await loginByPhone('+79991234567');
```

**Примечания:**
- Требует предварительной верификации через SMS (может быть отключено в текущей реализации)

---

### 2. Обновление токена

**Описание:** Обновление access токена с помощью refresh токена.

**Endpoint:** `POST /auth/refresh`

**Параметры:**
- `refresh: string` - refresh токен из `localStorage`

**Возвращает:** Новый `UserCredentials` объект

**Пример:**
```typescript
const newCredentials = await refreshToken();
if (newCredentials) {
  // Токены обновлены
} else {
  // Требуется повторный вход
}
```

**Примечания:**
- При неудаче автоматически очищает токены и редиректит на `/login`
- Refresh токен должен быть валидным и не истекшим

---

### 3. Выход из системы

**Описание:** Выход пользователя из системы с очисткой токенов.

**Пример:**
```typescript
logout();
// Токены удалены, пользователь перенаправлен на /login
```

**Примечания:**
- Удаляет `access_token` и `refresh_token` из `localStorage`
- Очищает токен в API клиенте
- Перенаправляет на страницу входа

---

## Работа с данными

### Получение списка новостей

**Описание:** Получение списка новостей с возможностью фильтрации.

**Endpoint:** `GET /news`

**Параметры запроса (опционально):**
- `categoryId?: number` - ID категории новостей
- `year?: number` - Год публикации

**Возвращает:** Массив объектов `News[]`

**Пример:**
```typescript
// Все новости
const allNews = await getNews();

// Новости определенной категории
const categoryNews = await getNews({ categoryId: 1 });

// Новости за определенный год
const yearNews = await getNews({ year: 2024 });
```

**Примечания:**
- Параметры передаются через URL query string
- Все параметры опциональны

---

### Создание новости

**Описание:** Создание новой новости (требует авторизации).

**Endpoint:** `POST /news`

**Параметры:**
- `newsData: CreateNewsRequest` - данные новости

**Возвращает:** Созданный объект `News`

**Пример:**
```typescript
const newNews = await createNews({
  title: 'Заголовок новости',
  description: 'Краткое описание',
  content: 'Полный текст новости',
  // ... другие поля
});
```

**Примечания:**
- Требует Bearer токен в заголовке `Authorization`
- Тип `CreateNewsRequest` определен в `API_CONTRACTS.ts`

---

### Загрузка файла

**Описание:** Загрузка файла (например, обложки новости).

**Endpoint:** `POST /news/:id/cover`

**Параметры:**
- `id: number` - ID новости
- `file: File` - файл для загрузки
- `fieldName: string` - имя поля в FormData (по умолчанию `'cover'`)

**Возвращает:** Информацию о загруженном файле

**Пример:**
```typescript
const file = event.target.files[0];
const uploadedFile = await uploadNewsCover(1, file);
console.log('Файл загружен:', uploadedFile);
```

**Примечания:**
- Использует `multipart/form-data` для загрузки
- Требует Bearer токен
- Поддерживает любые типы файлов (изображения, PDF, и т.д.)

---

### Поиск документов

**Описание:** Поиск документов с фильтрацией и пагинацией.

**Endpoint:** `GET /documents`

**Параметры запроса:**
- `query: string` - поисковый запрос (обязательный)
- `type?: string` - тип документа
- `year?: number` - год публикации
- `page?: number` - номер страницы
- `limit?: number` - количество элементов на странице

**Возвращает:** Объект с массивом документов и информацией о пагинации

**Пример:**
```typescript
const result = await searchDocuments('закон', {
  type: 'law',
  year: 2024,
  page: 1,
  limit: 10
});

console.log('Документы:', result.documents);
console.log('Пагинация:', result.pagination);
```

**Примечания:**
- Параметры передаются через URL query string
- Результат включает мета-информацию о пагинации

---

## Обработка ошибок

### Универсальный обработчик ошибок

**Описание:** Централизованная обработка ошибок API запросов.

**Обрабатываемые статусы:**
- `401` - Неавторизован: попытка обновить токен
- `403` - Нет доступа: показ сообщения об отсутствии доступа
- `404` - Не найдено: показ сообщения о том, что ресурс не найден
- `500` - Ошибка сервера: показ сообщения об ошибке сервера
- Другие: показ сообщения об ошибке из ответа сервера

**Пример:**
```typescript
try {
  const data = await api.get('/news');
} catch (error) {
  handleApiError(error);
}
```

**Примечания:**
- Обрабатывает три типа ошибок: ответ сервера, отсутствие ответа, ошибка настройки запроса
- Для 401 автоматически пытается обновить токен через `refreshToken()`

---

## React Hook примеры

### Хук для работы с новостями

**Описание:** React хук для управления состоянием новостей с загрузкой и созданием.

**Возвращает:**
- `news: News[]` - массив новостей
- `loading: boolean` - флаг загрузки
- `error: string | null` - сообщение об ошибке
- `createNews: (newsData: CreateNewsRequest) => Promise<News>` - функция создания новости

**Пример использования:**
```typescript
const { news, loading, error, createNews } = useNews({ categoryId: 1 });

if (loading) return <div>Загрузка...</div>;
if (error) return <div>Ошибка: {error}</div>;

return (
  <div>
    {news.map(item => <NewsItem key={item.id} news={item} />)}
  </div>
);
```

**Примечания:**
- Автоматически загружает новости при изменении фильтров
- Поддерживает оптимистичные обновления (добавление новости в список до получения ответа)

---

### Хук для аутентификации

**Описание:** React хук для управления состоянием аутентификации пользователя.

**Возвращает:**
- `user: User | null` - данные пользователя
- `loading: boolean` - флаг загрузки
- `isAuthenticated: boolean` - флаг авторизации
- `login: (email: string, password: string) => Promise<UserCredentials>` - функция входа
- `logout: () => void` - функция выхода

**Пример использования:**
```typescript
const { user, loading, isAuthenticated, login, logout } = useAuth();

if (loading) return <div>Проверка авторизации...</div>;

if (!isAuthenticated) {
  return <LoginForm onLogin={login} />;
}

return (
  <div>
    <p>Привет, {user.name}!</p>
    <button onClick={logout}>Выйти</button>
  </div>
);
```

**Примечания:**
- Автоматически проверяет токен при монтировании компонента
- При невалидном токене автоматически очищает его и устанавливает `isAuthenticated = false`

---

## Работа с файлами

### Загрузка изображения

**Описание:** Универсальная функция для загрузки изображений на сервер.

**Параметры:**
- `file: File` - файл для загрузки
- `endpoint: string` - endpoint API для загрузки
- `fieldName: string` - имя поля в FormData (по умолчанию `'image'`)

**Возвращает:** Информацию о загруженном файле

**Пример использования:**
```typescript
const handleImageUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
  const file = event.target.files?.[0];
  if (!file) return;

  try {
    const uploadedFile = await uploadImage(file, '/news/1/cover', 'cover');
    console.log('Файл загружен:', uploadedFile);
  } catch (error) {
    console.error('Ошибка загрузки:', error);
  }
};
```

**Примечания:**
- Использует `FormData` для отправки файла
- Требует Bearer токен в заголовке `Authorization`
- Поддерживает любые типы файлов

---

### Получение ссылки на файл

**Описание:** Получение URL для доступа к файлу по его ID.

**Параметры:**
- `fileId: string` - ID файла

**Возвращает:** Полный URL файла

**Пример:**
```typescript
const fileUrl = getFileUrl('file-uuid-123');
// Возвращает: http://localhost:4000/files/v2/file-uuid-123
```

**Альтернативный способ:**
```typescript
// Использование поля link из ответа API
const imageUrl = news.coverImage?.link;
```

**Примечания:**
- Файлы обычно возвращаются с полем `link` в ответах API
- Можно использовать либо `getFileUrl()`, либо поле `link` из объекта файла

---

## Пагинация

### Компонент пагинации

**Описание:** React компонент для отображения и управления пагинацией.

**Props:**
- `currentPage: number` - текущая страница
- `totalPages: number` - общее количество страниц
- `onPageChange: (page: number) => void` - callback при изменении страницы

**Пример использования:**
```typescript
const [currentPage, setCurrentPage] = useState(1);
const [totalPages, setTotalPages] = useState(10);

<Pagination
  currentPage={currentPage}
  totalPages={totalPages}
  onPageChange={(page) => {
    setCurrentPage(page);
    // Загрузить данные для новой страницы
  }}
/>
```

**Примечания:**
- Кнопки "Назад" и "Вперед" автоматически отключаются на первой/последней странице
- Компонент не управляет загрузкой данных, только отображает UI

---

## Рекомендации

**Описание:** Рекомендации по лучшим практикам интеграции фронтенда с бэкендом.

1. **Кэширование**: Используйте React Query или SWR для кэширования данных
   - Уменьшает количество запросов к серверу
   - Улучшает производительность приложения
   - Упрощает управление состоянием

2. **Обработка токенов**: Реализуйте автоматическое обновление токенов
   - Используйте interceptors в axios или обертку для fetch
   - Обрабатывайте 401 ошибки автоматически
   - Сохраняйте refresh токен в безопасном месте

3. **Валидация**: Используйте библиотеки типа Zod или Yup для валидации данных
   - Валидация на клиенте перед отправкой на сервер
   - Согласованность типов между фронтендом и бэкендом
   - Улучшенный UX с понятными сообщениями об ошибках

4. **Типизация**: Используйте TypeScript и типы из `API_CONTRACTS.ts`
   - Автодополнение в IDE
   - Обнаружение ошибок на этапе компиляции
   - Документирование API через типы

5. **Обработка ошибок**: Создайте централизованную систему обработки ошибок
   - Единый формат сообщений об ошибках
   - Логирование ошибок для отладки
   - Понятные сообщения для пользователей

6. **Загрузка файлов**: Показывайте прогресс загрузки для больших файлов
   - Используйте `XMLHttpRequest` или библиотеки с поддержкой прогресса
   - Показывайте процент загрузки
   - Обрабатывайте ошибки загрузки

7. **Оптимистичные обновления**: Обновляйте UI до получения ответа от сервера
   - Улучшает воспринимаемую производительность
   - Откатывайте изменения при ошибке
   - Используйте для не критичных операций

---

## Полезные ссылки

**Описание:** Ссылки на дополнительную документацию и ресурсы.

- **Полная документация API:** `API_DOCUMENTATION.md`
  - Подробное описание всех endpoints
  - Примеры запросов и ответов
  - Описание параметров и типов

- **TypeScript контракты:** `API_CONTRACTS.ts`
  - Все типы и интерфейсы для TypeScript
  - Enum'ы и константы
  - Используйте для типизации в проекте

- **Swagger UI:** `http://localhost:4000/api` (при запущенном сервере)
  - Интерактивная документация API
  - Возможность тестирования endpoints
  - Автоматически генерируется из декораторов NestJS

---

## Заключение

Эта документация предоставляет полное руководство по интеграции фронтенда с бэкендом API. Используйте примеры кода как отправную точку для реализации в вашем проекте. При возникновении вопросов обращайтесь к полной документации API или Swagger UI.
