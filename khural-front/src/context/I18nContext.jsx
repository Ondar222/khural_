import React from "react";
import { PublicApi } from "../api/client.js";

// Переводы, выгруженные из таблиц (ключ — русский текст, значение — тувинский)
const sheetTranslations = {
  "Главная": "Кол арын",
  "О Верховном Хурале": "Дээди Хуралдың Дугайында",
  "Структура": "Тургузуу",
  "Комитеты": "Комитеттер",
  "Комиссии": "Комиссиялар",
  "Депутатские фракции": "Депутаттар фракциялары",
  "Представительство в Совете Федерации": "Федерация Чөвүлелинге төлээ чери",
  "Аппарат": "Аппарат",
  "Контакты": "Харылзаа",
  "Депутаты": "Депутаттар",
  "Документы": "Документилер",
  "Документы: Законодательство": "Документилер: Хоойлу-Дүрүм",
  "Законодательство (Новости)": "Хоойлу-Дүрүм (Медээлер)",
  "Постановления ВХ РТ": "Доктаалдар",
  "Законодательные инициативы": "Хоойлужудулга инициативалары",
  "Инициатива гражданами": "Хамаатыларның эгелекчи саналы",
  "Поправки в Конституцию РФ": "РФ-ТИҢ Конституциязынче эдилгелер",
  "Законопроекты": "Хоойлу төлевилелдери",
  "Новости": "Медээлер",
  "Актуальные новости": "Чугула медээлер",
  "Все новости": "Шупту медээлер",
  "Медиа": "Медиа",
  "Молодежь": "Аныяктар",
  "Обращения": "Дилеглер",
  "Вход": "Кирери",
  "Регистрация": "Бүрүткээри",
  "Подробнее": "Тодаргайы-биле",
  "Все": "Шупту",
  "Открыть в разделе": "Кезекке ажыдар",
  "Заседание комитета": "Комитеттиң хуралы",
  "Зал заседаний Верховного Хурала": "Дээди Хуралдың хуралдаар залы",
  "Обсуждение законопроекта о...": "Хоойлу төлевилелин сайгарары о...",
  "Порталы": "Порталдар",
  "© 2025 ВЕРХОВНЫЙ ХУРАЛ РТ.": "2025 ТР-НИҢ ДЭЭДИ ХУРАЛЫ.",
  "ВСЕ ПРАВА ЗАЩИЩЕНЫ.": "ШУПТУ ЭРГЕЛЕР КАМГАЛАТТЫНГАН.",
  "Разработано Lana Soft": "Lana Soft-Биле Ажылдап Кылган",
  "О регионе": "Регион дугайында",
  "Парламент": "Парламент",
  "Прием обращений": "Дилеглерни хүлээп алыры",
  "Карта сайта": "Сайтының картазы",
  "Политика обработки ПДн": "ПДн болбаазырадыр Политика",
  "Лицензия": "Лицензия",
  "Соцсети": "Соцчеткилер",
  "ВКонтакте": "ВКонтакте",
  "Одноклассники": "Чаңгыс классчылар",
  "RuTube": "RuTube",
  "Адрес:": "Адрес:",
  "667000, г. Кызыл, ул. Чульдум, д. 18": "667000, Кызыл хоорай, Чульдум кудумчузу, 18 дугаар бажың.",
  "О Верховном Хурале Республики Тыва": "Тыва Республиканың Дээди Хуралының Дугайында",
  "Общие сведения": "Ниити медээлер",
  "Структура органов управления": "Башкарылга органнарының тургузуу",
  "Боковое меню": "Ниити медээ",
  "Структура парламента": "Парламентиниң тургузуу",
  "Руководство": "Удуртулга",
  "Руководство парламента": "Парламентиниң удуртулгазы",
  "Депутаты всех созывов": "Шупту чыыштарның депутаттары",
  "Совет по взаимодействию с представительными органами муниципальных образований":
    "Муниципалдыг тургузугларның төлээлекчи органнары-биле кады ажылдаар чөвүлел",
  "Структура Аппарата": "Аппараттың Тургузуу",
  "Молодежный Хурал": "Аныяктар Хуралы",
  "Председатель Верховного Хурала (парламента) Республики Тыва":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) даргазы",
  "Фракция Единая Россия": "Единая Россия фракциязы",
  "Фракция КПРФ": "КПРФ фракциязы",
  "Фракция ЛДПР": "ЛДПР фракциязы",
  "Фракция Новые люди": "Новые люди фракциязы",
  "Ниже — схема структуры. Нажмите на фракции/комитеты, чтобы перейти к соответствующим разделам.":
    "Адаанда-структураның схемазы. Чогуур кезектерже шилчиири-биле фракцияларны/комитеттерни базыңар.",
  "Комитеты Верховного Хурала (парламента) Республики Тыва":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) комитеттери",
  "Комитет по аграрной политике, земельным отношениям, природопользованию, экологии и делам коренных малочисленных народов":
    "Аграрлыг политика чер хамаарылгаларының бойдус ажыглалының экология болгаш эвээш санныг үндезин чоннарның херектериниң талазы-биле Комитет",
  "Комитет по развитию инфраструктуры и промышленной политике":
    "Инфраструктура хөгжүлдезиниң болгаш үлетпүр политиказының талазы-биле Комитет",
  "Комитет по молодежной, информационной политике, физической культуре и спорту, развитию институтов гражданского общества":
    "Аныяктар информастыг политика күш-культура болгаш спорт хамааты ниитилел институттарын сайзырадыр талазы-биле Комитет",
  "Комитет по безопасности и правопорядку": "Айыыл чок чорук болгаш корум-чурум талазы-биле Комитет",
  "Комитет по конституционно‑правовой политике и местному самоуправлению":
    "Конститустуг эрге‑хоойлу политиказы болгаш тус чер бот-башкарылгазының комитеди",
  "Комитет по экономической, финансово‑бюджетной и налоговой политике, предпринимательству, туризму и государственной собственности":
    "Экономика, саң‑хөө-бюджет болгаш үндүрүг политиказы, сайгарлыкчы чорук, туризм болгаш күрүне өнчүзүнүң талазы-биле Комитет",
  "Комитет по образованию, культуре, науке и национальной политике":
    "Өөредилге культура эртем болгаш национал политика талазы-биле Комитет",
  "Комитет Верховного Хурала (парламента) Республики Тыва по межрегиональным связям":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) регионнар аразында харылзаалар талазы-биле комитеди",
  "Комитет Верховного Хурала (парламента) Республики Тыва по взаимодействию со средствами массовой информации и общественными организациями":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) массалыг информация чепсектери болгаш хөй-ниити организациялары-биле кады ажылдажылга комитеди",
  "Комиссия Верховного Хурала (парламента) Республики Тыва по Регламенту Верховного Хурала (парламента) Республики Тыва и депутатской этике":
    "Тыва республиканың Дээди Хуралының (парламентизиниң) Регламентизиниң болгаш депутаттарның этиказының талазы-биле комиссиязы",
  "Комиссия Верховного Хурала (парламента) Республики Тыва контрольно за достоверностью сведений о доходах, об имуществе и обязательствах имущественного характера, представляемых депутатами Верховного Хурала (парламента) Республики Тыва":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) комиссиязы тыва республиканың Дээди Хуралының (парламентизиниң) депутаттарының киирип турары орулгаларының, эт-хөреңгизиниң болгаш эт-хөреңги талазы-биле хүлээлгелериниң дугайында медээлерниң шынныын хынаар",
  "Наградная комиссия Верховного Хурала (парламента) Республики Тыва":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) шаңнал комиссиязы",
  "Комиссия Верховного Хурала (парламента) Республики Тыва по поддержке участников специальной военной операции и их семей":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) тускай шериг операциязының киржикчилерин болгаш оларның өг-бүлелерин деткиир комиссиязы",
  "Счетная комиссия Верховного Хурала (парламента) Республики Тыва":
    "Тыва Республиканың Дээди Хуралының (парламентизиниң) саналга комиссиязы",
  "Приём:": "Хүлээп алыышкын:",
  "Заместитель Председателя Верховного Хурала (парламента) Республики":
    "Республиканың Дээди Хуралының (парламентизиниң) Даргазының оралакчызы",
  "Законы Республики Тыва": "Тыва Республиканың Хоойлулары",
  "Законодательная инициатива гражданами": "Хамаатыларның хоойлужудулга эгелээшкини",
  "Реализация поправок в Конституцию РФ": "РФ-ТИҢ Конституциязынче эдилгелерни боттандырары",
  "По названию, номеру, описанию": "Ады, дугаары, тайылбыры-биле",
  "Обращения граждан": "Хамаатыларның дилеглери",
  "Для отправки обращения требуется авторизация": "Кыйгырыгны чорударынга авторизация негеттинер",
  "Перейдите на страницу входа или регистрации, затем вернитесь сюда.":
    "Кирериниң азы бүрүткээриниң арынынче киргеш, оон бээр эглип келиңер.",
  "Подать обращение": "Дилег киирер",
  "Мои обращения": "Мээң дилеглерим",
  "Отчество (если есть)": "Адазының ады (бар болза)",
  "Текст обращения": "Кыйгырыгның сөзүглели",
  "Я согласен(на) на обработку персональных данных и подтверждаю достоверность сведений.":
    "Персоналдыг медээлерни болбаазырадырынга чөпшээрежип, медээлерниң шынныын бадыткап тур мен.",
  "Политика обработки персональных данных": "Персоналдыг медээлерни болбаазырадырының политиказы",
  "Для отправки обращения необходимо войти или зарегистрироваться":
    "Дилегни чорударда кирер азы бүрүткедир",
  "Правила о приеме обращений граждан": "Хамаатыларның дилеглерин хүлээп алырының дугайында дүрүмнер",
  "Войдите, чтобы видеть историю обращений.": "Дилеглерниң төөгүзүн көөрү-биле кириңер.",
};

const dict = {
  ru: {
    home: "Главная",
    aboutVH: "О Верховном Хурале",
    structure: "Структура",
    committees: "Комитеты",
    commissions: "Комиссии",
    factions: "Депутатские фракции",
    senateRep: "Представительство в Совете Федерации",
    apparatus: "Аппарат",
    brandTop: "Верховный Хурал",
    brandParliament: "(парламент)",
    brandBottom: "Республика Тыва",
    more: "Подробнее",
    news: "Новости",
    calendar: "Календарь",
    calendarOpen: "Открыть в разделе",
    prevMonth: "Предыдущий месяц",
    nextMonth: "Следующий месяц",
    documents: "Документы",
    deputies: "Депутаты",
    appeals: "Обращения",
    media: "Медиа",
    sessions: "Сессии",
    legislation: "Законодательство",
    publicEvents: "Общественные мероприятия",
    workWithCitizens: "Работа с гражданами",
    allNews: "Все новости",
    hotNews: "Актуальные новости",
    search: "Поиск",
    category: "Категория",
    month: "Месяц",
    priorities: "Приоритеты",
    openAllPriorities: "Открыть все приоритеты",
    achievementsTitle: "Достижения региона",
    achievementsMore: "Больше достопримечательностей",
    region: "О регионе",
    government: "Парламент",
    authorities: "Органы власти",
    docs: "Документы",
    feedback: "Прием обращений",
    press: "Пресс‑служба",
    activity: "Деятельность",
    contacts: "Контакты",
    login: "Вход",
    register: "Регистрация",
    back: "← К списку",
    otherNews: "Другие новости",
    head: "Глава",
    deputiesAll: "Депутаты всех созывов",
    docsLaws: "Законы Республики Тыва",
    docsResolutions: "Постановления ВХ РТ",
    docsInitiatives: "Законодательные инициативы",
    docsCivic: "Инициатива гражданами",
    docsConstitution: "Поправки в Конституцию РФ",
    docsBills: "Законопроекты",
    wifiMap: "Карта WiFi",
    map: "Карта",
    sitemap: "Карта сайта",
    pdPolicy: "Политика обработки ПДн",
    license: "Лицензия",
    socials: "Соцсети",
    vk: "ВКонтакте",
    ok: "Одноклассники",
    rutube: "RuTube",
    show: "Показать",
    hide: "Скрыть",
    portals: "Порталы",
    goHome: "На главную",
    socialNetworksHead: "Соцсети руководства",
    subscribe: "Подписаться",
    localSelfGovernment: "Местное самоуправление",
    legislativeAssembly: "Законодательное собрание",
    territorialDepartments: "Территориальные подразделения",
    headsOfBodies: "Руководители органов",
    strategy: "Стратегия",
    plansAndForecasts: "Планы и прогнозы",
    resultsAndReports: "Результаты и отчеты",
    announcements: "Анонсы",
    governmentComposition: "Состав правительства",
    executiveBodies: "Исполнительные органы",
    accessibilityVersion: "Версия для слабовидящих",
    changeLanguage: "Сменить язык",
    menu: "Меню",
    close: "Закрыть",
    // Автоматически добавленные пары из таблицы
    ...Object.fromEntries(Object.keys(sheetTranslations).map((k) => [k, k])),
  },
  ty: {
    home: "Кол арын",
    aboutVH: "Дээди Хуралдың Дугайында",
    structure: "Тургузуу",
    committees: "Комитеттер",
    commissions: "Комиссиялар",
    factions: "Депутаттар фракциялары",
    senateRep: "Федерация Чөвүлелинге төлээ чери",
    apparatus: "Аппарат",
    brandTop: "Тыва Республиканың Дээди Хуралы",
    brandParliament: "(парламентизи)",
    brandBottom: "Тыва Республиканың",
    more: "Тодаргайы-биле",
    news: "Медээлер",
    calendar: "Календарь",
    calendarOpen: "Кезекке ажыдар",
    prevMonth: "Ылараа ай",
    nextMonth: "Келир ай",
    documents: "Документилер",
    deputies: "Депутаттар",
    appeals: "Дилеглер",
    media: "Медиа",
    sessions: "Сессиялар",
    legislation: "Хоойлу-Дүрүм",
    publicEvents: "Хоорай чогаалдар",
    workWithCitizens: "Хамаатылар-биле ажыл",
    allNews: "Шупту медээлер",
    hotNews: "Чугула медээлер",
    search: "Диледир",
    category: "Категория",
    month: "Ай",
    priorities: "Чүве чүүлдер",
    openAllPriorities: "Шупту чүүлдерни ачыр",
    achievementsTitle: "Регионалыг чедиишкиннер",
    achievementsMore: "Достокчерилер чөп",
    region: "Регион дугайында",
    government: "Парламент",
    authorities: "Күрүне органнары",
    docs: "Документилер",
    feedback: "Дилеглерни хүлээп алыры",
    press: "Пресс-служба",
    activity: "Ажыл-чорулга",
    contacts: "Харылзаа",
    login: "Кирери",
    register: "Бүрүткээри",
    back: "← Хевири",
    otherNews: "Башка медээлер",
    head: "Башкы",
    deputiesAll: "Шупту чыыштарның депутаттары",
    docsLaws: "Тыва Республиканың Хоойлулары",
    docsResolutions: "Доктаалдар",
    docsInitiatives: "Хоойлужудулга инициативалары",
    docsCivic: "Хамаатыларның эгелекчи саналы",
    docsConstitution: "РФ-ТИҢ Конституциязынче эдилгелер",
    docsBills: "Хоойлу төлевилелдери",
    wifiMap: "Wi‑Fi карта",
    map: "Карта",
    sitemap: "Сайтының картазы",
    pdPolicy: "ПДн болбаазырадыр Политика",
    license: "Лицензия",
    socials: "Соцчеткилер",
    vk: "ВКонтакте",
    ok: "Чаңгыс классчылар",
    rutube: "RuTube",
    show: "Көргүзер",
    hide: "Чыып каар",
    portals: "Порталдар",
    goHome: "Кол арынына",
    socialNetworksHead: "Тыва Республиканың Башкызының Социаль сетьтери",
    subscribe: "Бүгүнүң",
    localSelfGovernment: "Чуртталга",
    legislativeAssembly: "Канун чыыры",
    territorialDepartments: "Территориялыг бөлүктер",
    headsOfBodies: "Органнарның башкылары",
    strategy: "Стратегия",
    plansAndForecasts: "Планнар болгаш прогнозтар",
    resultsAndReports: "Чедиишкиннер болгаш отчеттар",
    announcements: "Медээлер",
    governmentComposition: "Күрүне бүрүзү",
    executiveBodies: "Чорудулга органнары",
    accessibilityVersion: "Көрүр күчүн кызылдары үчүн версия",
    changeLanguage: "Дылды солуур",
    menu: "Меню",
    close: "Дайын",
    // Переводы из таблицы (по ключам-строкам)
    ...sheetTranslations,
  },
};

const I18nContext = React.createContext({
  lang: "ru",
  t: (k) => k,
  setLang: () => {},
});
export function useI18n() {
  return React.useContext(I18nContext);
}

export default function I18nProvider({ children }) {
  const [lang, setLang] = React.useState(() => {
    try {
      const saved = localStorage.getItem("site_lang");
      if (saved === "ru" || saved === "ty" || saved === "tyv")
        return saved === "tyv" ? "ty" : saved;
    } catch {}
    const docLang = typeof document !== "undefined" ? document.documentElement.lang : "";
    if (docLang === "ty" || docLang === "ru" || docLang === "tyv")
      return docLang === "tyv" ? "ty" : docLang;
    const nav = (typeof navigator !== "undefined" && navigator.language) || "ru";
    return nav.startsWith("ty") ? "ty" : "ru";
  });

  // Кэш для переводов через API
  const translationCache = React.useRef(new Map());
  const [apiTranslations, setApiTranslations] = React.useState({});

  React.useEffect(() => {
    try {
      localStorage.setItem("site_lang", lang === "ty" ? "tyv" : lang);
    } catch {}
    if (typeof document !== "undefined") {
      const htmlLang = lang === "ty" ? "tyv" : lang;
      document.documentElement.lang = htmlLang;
      document.documentElement.setAttribute("data-lang", htmlLang);
    }
  }, [lang]);

  // Предзагрузка переводов через API при смене языка
  React.useEffect(() => {
    if (lang === "ty" && dict.ru) {
      // Сначала используем статический словарь для мгновенного отображения
      const staticTranslations = {};
      Object.keys(dict.ru).forEach((key) => {
        staticTranslations[key] = dict.ty && dict.ty[key] ? dict.ty[key] : dict.ru[key];
      });
      setApiTranslations(staticTranslations);

      // Затем загружаем переводы через API для обновления
      const loadTranslations = async () => {
        const newTranslations = { ...staticTranslations };
        const keys = Object.keys(dict.ru);

        // Загружаем переводы батчами для производительности
        const batchSize = 5;
        for (let i = 0; i < keys.length; i += batchSize) {
          const batch = keys.slice(i, i + batchSize);
          await Promise.all(
            batch.map(async (key) => {
              const cacheKey = `ru-ty-${dict.ru[key]}`;
              if (translationCache.current.has(cacheKey)) {
                newTranslations[key] = translationCache.current.get(cacheKey);
                return;
              }

              try {
                const result = await PublicApi.translate(dict.ru[key], "ru", "ty");
                // Пробуем разные форматы ответа API
                let translated = null;

                if (typeof result === "string") {
                  translated = result;
                } else if (result) {
                  translated =
                    result?.translated ||
                    result?.text ||
                    result?.result ||
                    result?.translation ||
                    result?.target ||
                    result?.data?.translated ||
                    result?.data?.text ||
                    result?.data?.result ||
                    null;
                }

                if (translated && translated !== dict.ru[key] && translated.trim()) {
                  translationCache.current.set(cacheKey, translated);
                  newTranslations[key] = translated;
                }
              } catch {
                // Оставляем статический перевод, не логируем ошибки для каждого ключа
                // console.warn(`Translation error for key ${key}:`, error);
              }
            })
          );

          // Обновляем состояние после каждого батча для постепенного обновления
          setApiTranslations({ ...newTranslations });
        }
      };

      loadTranslations();
    } else {
      setApiTranslations({});
    }
  }, [lang]);

  const t = React.useCallback(
    (key) => {
      // Если язык тувинский
      if (lang === "ty") {
        // Сначала проверяем переводы через API
        if (apiTranslations[key]) {
          return apiTranslations[key];
        }
        // Затем статический словарь
        if (dict.ty && dict.ty[key]) {
          return dict.ty[key];
        }
        // Fallback на русский
        return dict.ru && dict.ru[key] ? dict.ru[key] : key;
      }

      // Для русского языка используем статический словарь
      if (dict[lang] && dict[lang][key]) {
        return dict[lang][key];
      }

      // Fallback на русский или ключ
      return dict.ru && dict.ru[key] ? dict.ru[key] : key;
    },
    [lang, apiTranslations]
  );

  const value = React.useMemo(() => ({ lang, setLang, t }), [lang, t]);
  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}
